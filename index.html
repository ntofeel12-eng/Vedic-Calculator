<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vedic Calculator</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.js"></script>
  <style>
    :root {
      --bg-light: #f0f2f5;
      --bg-dark: #0b1120;
      --card-bg-light: #fff;
      --card-bg-dark: #121a2f;
      --text-light: #222;
      --text-dark: #e0f7fa;
      --accent-color: #00e5ff;
      --btn-bg-light: #d0e9ff;
      --btn-bg-dark: #1c2a44;
      --btn-hover-light: #a9d4ff;
      --btn-hover-dark: #3388ff;
      --btn-equal-bg: #00bcd4;
      --btn-equal-hover: #0097a7;
      --btn-disabled-bg: #555a66;
      --btn-disabled-text: #999;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding: 1rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.light-theme {
      background-color: var(--bg-light);
      color: var(--text-light);
    }

    #calculator {
      background-color: var(--card-bg-dark);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 360px;
      max-width: 100vw;
      box-shadow: 0 0 20px rgb(0 229 255 / 0.5);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transition: background-color 0.3s ease;
    }

    body.light-theme #calculator {
      background-color: var(--card-bg-light);
      box-shadow: 0 0 20px rgb(0 105 173 / 0.5);
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--accent-color);
      font-weight: 700;
      font-size: 1.3rem;
      user-select: none;
    }

    #display {
      width: 100%;
      font-size: 2rem;
      font-weight: 700;
      color: inherit;
      background-color: transparent;
      border: 2px solid transparent;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      text-align: right;
      outline-offset: 2px;
      caret-color: var(--accent-color);
      transition: border-color 0.3s ease;
    }

    #display:focus {
      border-color: var(--accent-color);
      background-color: rgba(0, 229, 255, 0.1);
    }

    .btn-control,
    .btn-calc {
      border-radius: 0.5rem;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 44px;
    }

    /* Control Buttons */
    .btn-control {
      background-color: var(--btn-bg-dark);
      color: var(--text-dark);
    }
    body.light-theme .btn-control {
      background-color: var(--btn-bg-light);
      color: var(--text-light);
    }
    .btn-control:hover:not(:disabled),
    .btn-control:focus-visible:not(:disabled) {
      background-color: var(--btn-hover-dark);
      color: var(--text-light);
    }
    body.light-theme
      .btn-control:hover:not(:disabled),
    body.light-theme
      .btn-control:focus-visible:not(:disabled) {
      background-color: var(--btn-hover-light);
      color: var(--text-dark);
    }

    /* Calculator Buttons */
    .btn-calc {
      background-color: var(--btn-bg-dark);
      color: var(--text-dark);
      font-size: 1.2rem;
      width: 100%;
    }
    body.light-theme .btn-calc {
      background-color: var(--btn-bg-light);
      color: var(--text-light);
    }
    .btn-calc:hover:not(:disabled),
    .btn-calc:focus-visible:not(:disabled) {
      background-color: var(--btn-hover-dark);
      color: var(--text-light);
    }
    body.light-theme
      .btn-calc:hover:not(:disabled),
    body.light-theme
      .btn-calc:focus-visible:not(:disabled) {
      background-color: var(--btn-hover-light);
      color: var(--text-dark);
    }

    /* Equal and Clear Buttons */
    #equalBtn,
    #clearBtn {
      background-color: var(--btn-equal-bg);
      color: #fff;
    }
    #equalBtn:hover,
    #equalBtn:focus-visible,
    #clearBtn:hover,
    #clearBtn:focus-visible {
      background-color: var(--btn-equal-hover);
    }

    #equalBtn:disabled,
    #clearBtn:disabled {
      background-color: var(--btn-disabled-bg);
      color: var(--btn-disabled-text);
      cursor: not-allowed;
    }

    /* Grid Layout */
    #buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6rem;
    }

    #control-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    /* History and Steps */
    #history,
    #steps {
      background-color: rgba(0, 229, 255, 0.1);
      border-radius: 0.5rem;
      padding: 0.5rem;
      max-height: 140px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--accent-color);
      user-select: text;
    }

    body.light-theme #history,
    body.light-theme #steps {
      background-color: rgba(0, 105, 173, 0.1);
      color: var(--accent-color);
    }

    /* Graph and Ink Panels */
    #graphPanel,
    #inkPanel {
      background-color: var(--card-bg-dark);
      border-radius: 0.5rem;
      padding: 0.5rem;
      margin-top: 1rem;
      display: none;
      box-shadow: 0 0 10px var(--accent-color);
      transition: background-color 0.3s ease;
    }

    body.light-theme #graphPanel,
    body.light-theme #inkPanel {
      background-color: var(--card-bg-light);
    }

    #graph {
      width: 100%;
      height: 200px;
      background-color: #000;
      border-radius: 0.5rem;
    }

    #ink {
      width: 100%;
      height: 200px;
      border: 2px solid var(--accent-color);
      border-radius: 0.5rem;
      background-color: #fff;
      touch-action: none;
    }

    /* Responsive */
    @media (max-width: 400px) {
      #calculator {
        width: 100%;
        padding: 1rem;
      }
      #buttons {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <main id="calculator" role="application" aria-label="Vedic Calculator">
    <header id="header" aria-live="polite" aria-atomic="true">
      <div>Vedic Calculator</div>
      <div aria-hidden="true" style="font-size: 1.5rem;">‡•ê</div>
    </header>

    <input
      id="display"
      type="text"
      aria-label="Calculator input"
      autocomplete="off"
      spellcheck="false"
      inputmode="decimal"
      role="textbox"
      aria-multiline="false"
    />

    <section id="control-buttons" aria-label="Calculator controls">
      <button class="btn btn-control" id="themeToggleBtn" aria-pressed="false" type="button">Theme</button>
      <button class="btn btn-control" id="vedicToggleBtn" aria-pressed="false" type="button">Vedic</button>
      <button class="btn btn-control" id="angleToggleBtn" aria-pressed="false" type="button">DEG</button>
      <button class="btn btn-control" id="voiceBtn" type="button" aria-label="Voice input">üéôÔ∏è</button>
      <button class="btn btn-control" id="examToggleBtn" aria-pressed="false" type="button">Exam</button>
      <button class="btn btn-control" id="graphToggleBtn" aria-pressed="false" type="button">Graph</button>
      <button class="btn btn-control" id="inkToggleBtn" aria-pressed="false" type="button">Handwriting</button>
    </section>

    <section id="buttons" aria-label="Calculator buttons">
      <!-- Row 1 -->
      <button class="btn btn-calc" data-value="7" type="button">7</button>
      <button class="btn btn-calc" data-value="8" type="button">8</button>
      <button class="btn btn-calc" data-value="9" type="button">9</button>
      <button class="btn btn-calc" data-value=" / " aria-label="Divide" type="button">√∑</button>
      <button class="btn btn-calc" data-value="(" aria-label="Open parenthesis" type="button">(</button>

      <!-- Row 2 -->
      <button class="btn btn-calc" data-value="4" type="button">4</button>
      <button class="btn btn-calc" data-value="5" type="button">5</button>
      <button class="btn btn-calc" data-value="6" type="button">6</button>
      <button class="btn btn-calc" data-value=" * " aria-label="Multiply" type="button">√ó</button>
      <button class="btn btn-calc" data-value=")" aria-label="Close parenthesis" type="button">)</button>

      <!-- Row 3 -->
      <button class="btn btn-calc" data-value="1" type="button">1</button>
      <button class="btn btn-calc" data-value="2" type="button">2</button>
      <button class="btn btn-calc" data-value="3" type="button">3</button>
      <button class="btn btn-calc" data-value=" - " aria-label="Subtract" type="button">‚àí</button>
      <button class="btn btn-calc" data-value=" ^ " aria-label="Power" type="button">^</button>

      <!-- Row 4 -->
      <button class="btn btn-calc" data-value="0" type="button">0</button>
      <button class="btn btn-calc" data-value="." aria-label="Decimal point" type="button">.</button>
      <button class="btn btn-calc" data-value=" + " aria-label="Add" type="button">+</button>
      <button class="btn btn-calc" data-value="sin(" aria-label="Sine function" type="button">sin</button>
      <button class="btn btn-calc" data-value="cos(" aria-label="Cosine function" type="button">cos</button>

      <!-- Row 5 -->
      <button class="btn btn-calc" data-value="tan(" aria-label="Tangent function" type="button">tan</button>
      <button class="btn btn-calc" id="equalBtn" type="button" aria-label="Equals">=</button>
      <button class="btn btn-calc" id="clearBtn" type="button" aria-label="Clear">C</button>
    </section>

    <section id="steps" aria-live="polite" aria-atomic="true" style="display:none;"></section>
    <section id="history" aria-live="polite" aria-atomic="true" style="display:none;"></section>

    <!-- Graph Panel -->
    <section id="graphPanel" aria-label="Graph plotting panel" style="display:none;">
      <canvas id="graph" width="320" height="200" role="img" aria-label="Graph plotting area"></canvas>
      <button id="plotBtn" class="btn btn-control mt-2" type="button">Plot Graph</button>
    </section>

    <!-- Handwriting Panel -->
    <section id="inkPanel" aria-label="Handwriting input panel" style="display:none;">
      <canvas id="ink" width="320" height="200" aria-label="Handwriting input area"></canvas>
      <div class="mt-2 d-flex gap-2">
        <button id="insertInkBtn" class="btn btn-control flex-grow-1" type="button">Insert</button>
        <button id="clearInkBtn" class="btn btn-control flex-grow-1" type="button">Clear</button>
      </div>
    </section>
  </main>

  <script>
    // References
    const display = document.getElementById("display");
    const stepsPanel = document.getElementById("steps");
    const historyPanel = document.getElementById("history");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const vedicToggleBtn = document.getElementById("vedicToggleBtn");
    const angleToggleBtn = document.getElementById("angleToggleBtn");
    const examToggleBtn = document.getElementById("examToggleBtn");
    const graphToggleBtn = document.getElementById("graphToggleBtn");
    const inkToggleBtn = document.getElementById("inkToggleBtn");
    const voiceBtn = document.getElementById("voiceBtn");
    const graphPanel = document.getElementById("graphPanel");
    const inkPanel = document.getElementById("inkPanel");
    const graphCanvas = document.getElementById("graph");
    const plotBtn = document.getElementById("plotBtn");
    const inkCanvas = document.getElementById("ink");
    const insertInkBtn = document.getElementById("insertInkBtn");
    const clearInkBtn = document.getElementById("clearInkBtn");

    const equalBtn = document.getElementById("equalBtn");
    const clearBtn = document.getElementById("clearBtn");
    const buttons = document.querySelectorAll(".btn-calc[data-value]");

    let darkTheme = true;
    let vedicMode = false;
    let angleMode = "DEG"; // or RAD
    let exam = false;

    // Toggle Theme
    function toggleTheme() {
      darkTheme = !darkTheme;
      if (darkTheme) {
        document.body.classList.remove("light-theme");
        themeToggleBtn.setAttribute("aria-pressed", "false");
      } else {
        document.body.classList.add("light-theme");
        themeToggleBtn.setAttribute("aria-pressed", "true");
      }
    }

    // Toggle Vedic Mode (placeholder)
    function toggleVedic() {
      vedicMode = !vedicMode;
      vedicToggleBtn.setAttribute("aria-pressed", vedicMode.toString());
      // Vedic mode can adjust calculation logic if implemented
      // Currently placeholder only
    }

    // Toggle Angle Mode (DEG/RAD)
    function toggleAngle() {
      angleMode = angleMode === "DEG" ? "RAD" : "DEG";
      angleToggleBtn.textContent = angleMode;
      angleToggleBtn.setAttribute("aria-pressed", (angleMode === "RAD").toString());
    }

    // Toggle Exam Mode
    function toggleExam() {
      exam = !exam;
      examToggleBtn.setAttribute("aria-pressed", exam.toString());
      // Disable all inputs/buttons except clear and theme toggle
      buttons.forEach((btn) => (btn.disabled = exam));
      equalBtn.disabled = exam;
      clearBtn.disabled = false; // Always enable clear
      voiceBtn.disabled = exam;
      vedicToggleBtn.disabled = exam;
      angleToggleBtn.disabled = exam;
      graphToggleBtn.disabled = exam;
      inkToggleBtn.disabled = exam;
      insertInkBtn.disabled = exam;
      clearInkBtn.disabled = exam;
      plotBtn.disabled = exam;
      display.readOnly = exam;
    }

    // Add input to display
    function add(value) {
      if (exam) return;
      display.value += value;
      display.focus();
    }

    // Clear display and panels
    function clearDisplay() {
      if (exam) return;
      display.value = "";
      stepsPanel.style.display = "none";
      historyPanel.style.display = "none";
      stepsPanel.innerHTML = "";
      historyPanel.innerHTML = "";
      display.focus();
    }

    // Calculate expression with math.js with angle mode
    function calculate() {
      if (exam) return;

      const expr = display.value.trim();
      if (!expr) return;

      try {
        // Create math.js instance with overridden trig functions for angle mode
        const config = {
          number: "number",
          precision: 14,
        };
        const mathInstance = math.create(math.all, config);

        // Override trig functions for degree mode
        if (angleMode === "DEG") {
          mathInstance.import({
            sin: function (x) {
              return Math.sin((x * Math.PI) / 180);
            },
            cos: function (x) {
              return Math.cos((x * Math.PI) / 180);
            },
            tan: function (x) {
              return Math.tan((x * Math.PI) / 180);
            },
          }, { override: true });
        }

        // Evaluate expression
        const result = mathInstance.evaluate(expr);

        display.value = result.toString();

        // Clear step panel as advanced symbolic steps not implemented
        stepsPanel.style.display = "none";
        stepsPanel.innerHTML = "";

        // Show expression and result in history
        historyPanel.style.display = "block";
        historyPanel.innerHTML = `
          <div>Expression: <code>${escapeHTML(expr)}</code></div>
          <div>= <strong>${escapeHTML(result.toString())}</strong></div>
        `;
      } catch (e) {
        stepsPanel.style.display = "block";
        stepsPanel.textContent = "Error: " + e.message;
        historyPanel.style.display = "none";
        historyPanel.innerHTML = "";
      }
    }

    // Escape HTML for safe display
    function escapeHTML(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Toggle Graph panel display
    function toggleGraph() {
      const visible = graphPanel.style.display === "block";
      graphToggleBtn.setAttribute("aria-pressed", (!visible).toString());
      graphPanel.style.display = visible ? "none" : "block";
      if (!visible) {
        inkPanel.style.display = "none";
        inkToggleBtn.setAttribute("aria-pressed", "false");
      }
    }

    // Toggle Ink panel display
    function toggleInk() {
      const visible = inkPanel.style.display === "block";
      inkToggleBtn.setAttribute("aria-pressed", (!visible).toString());
      inkPanel.style.display = visible ? "none" : "block";
      if (!visible) {
        graphPanel.style.display = "none";
        graphToggleBtn.setAttribute("aria-pressed", "false");
      }
    }

    // Plot graph of expression
    function plotGraph() {
      const ctx = graphCanvas.getContext("2d");
      const expr = display.value.trim();
      if (!expr) return;

      try {
        ctx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
        ctx.strokeStyle = "#00e5ff";
        ctx.lineWidth = 2;
        ctx.beginPath();

        const mathInstance = math.create(math.all);

        // X range from -10 to 10, scale to canvas width
        const width = graphCanvas.width;
        const height = graphCanvas.height;

        for (let px = 0; px < width; px++) {
          const x = (px / width) * 20 - 10;
          let y;
          try {
            // Evaluate expression with x replaced
            y = mathInstance.evaluate(expr.replace(/x/g, `(${x})`));
            if (typeof y !== "number" || !isFinite(y)) y = NaN;
          } catch {
            y = NaN;
          }
          const py = height - ((y + 10) / 20) * height;
          if (px === 0) {
            ctx.moveTo(px, py);
          } else if (!isNaN(y)) {
            ctx.lineTo(px, py);
          } else {
            ctx.moveTo(px, py);
          }
        }
        ctx.stroke();
      } catch (e) {
        alert("Graph error: " + e.message);
      }
    }

    // Handwriting input setup (simple Ink canvas)
    const inkCtx = inkCanvas.getContext("2d");
    let drawing = false;
    let points = [];

    inkCanvas.style.touchAction = "none";

    inkCanvas.addEventListener("pointerdown", (e) => {
      if (exam) return;
      drawing = true;
      points.push({ x: e.offsetX, y: e.offsetY });
      inkCtx.beginPath();
      inkCtx.moveTo(e.offsetX, e.offsetY);
    });

    inkCanvas.addEventListener("pointermove", (e) => {
      if (!drawing) return;
      points.push({ x: e.offsetX, y: e.offsetY });
      inkCtx.lineTo(e.offsetX, e.offsetY);
      inkCtx.strokeStyle = "#00e5ff";
      inkCtx.lineWidth = 2;
      inkCtx.lineCap = "round";
      inkCtx.lineJoin = "round";
      inkCtx.stroke();
    });

    inkCanvas.addEventListener("pointerup", () => {
      drawing = false;
      points = [];
    });

    inkCanvas.addEventListener("pointerleave", () => {
      drawing = false;
      points = [];
    });

    // Clear Ink canvas
    function clearInk() {
      if (exam) return;
      inkCtx.clearRect(0, 0, inkCanvas.width, inkCanvas.height);
      points = [];
    }

    // Insert recognized ink input (placeholder)
    function insertInk() {
      if (exam) return;
      // This is a placeholder: no handwriting recognition implemented
      alert("Handwriting recognition not implemented. Drawn input cannot be converted yet.");
    }

    // Voice input setup (if available)
    function startVoice() {
      if (exam) return;
      if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) {
        alert("Speech recognition not supported in this browser.");
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        display.value += transcript;
        display.focus();
      };

      recognition.onerror = (event) => {
        alert("Speech recognition error: " + event.error);
      };

      recognition.start();
    }

    // Event listeners
    themeToggleBtn.addEventListener("click", toggleTheme);
    vedicToggleBtn.addEventListener("click", toggleVedic);
    angleToggleBtn.addEventListener("click", toggleAngle);
    examToggleBtn.addEventListener("click", toggleExam);
    graphToggleBtn.addEventListener("click", toggleGraph);
    inkToggleBtn.addEventListener("click", toggleInk);
    voiceBtn.addEventListener("click", startVoice);
    plotBtn.addEventListener("click", plotGraph);
    clearInkBtn.addEventListener("click", clearInk);
    insertInkBtn.addEventListener("click", insertInk);

    // Buttons input
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        add(btn.getAttribute("data-value"));
      });
    });

    // Clear and equal
    clearBtn.addEventListener("click", clearDisplay);
    equalBtn.addEventListener("click", calculate);

    // Keyboard support for Enter key
    display.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        calculate();
      } else if (e.key === "Escape") {
        e.preventDefault();
        clearDisplay();
      }
    });

    // Initialize UI state
    themeToggleBtn.setAttribute("aria-pressed", "false");
    vedicToggleBtn.setAttribute("aria-pressed", "false");
    angleToggleBtn.textContent = angleMode;
    angleToggleBtn.setAttribute("aria-pressed", "false");
    examToggleBtn.setAttribute("aria-pressed", "false");
    graphToggleBtn.setAttribute("aria-pressed", "false");
    inkToggleBtn.setAttribute("aria-pressed", "false");

    // Focus display on load
    display.focus();
  </script>
</body>
</html>
